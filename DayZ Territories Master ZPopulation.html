<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>DayZ Territories Master ZPopulation</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #0a0a0a; color: #e0e0e0; padding: 20px; margin: 0; }
        .container { max-width: 1550px; margin: auto; background: #161616; padding: 25px; border-radius: 12px; border: 1px solid #333; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        h2 { color: #e74c3c; margin: 0 0 20px 0; display: flex; align-items: center; gap: 10px; }
        .layout { display: flex; gap: 25px; }
        .side { flex: 1; min-width: 0; }
        textarea { width: 100%; height: 280px; background: #000; color: #00ff00; border: 1px solid #444; padding: 12px; font-family: monospace; font-size: 11px; border-radius: 5px; }
        .config-panel { background: #222; padding: 20px; border-radius: 8px; border: 1px solid #444; height: fit-content; }
        .grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-top: 15px; }
        .field { display: flex; flex-direction: column; }
        label { font-size: 11px; color: #e67e22; font-weight: bold; margin-bottom: 5px; text-transform: uppercase; }
        select, input { padding: 10px; background: #333; color: white; border: 1px solid #555; border-radius: 4px; font-size: 13px; }
        .btn { width: 100%; padding: 14px; font-weight: bold; cursor: pointer; border: none; border-radius: 4px; text-transform: uppercase; margin-top: 10px; transition: 0.3s; }
        .btn-parse { background: #8e44ad; color: white; }
        .btn-apply { background: #e74c3c; color: white; border-bottom: 4px solid #c0392b; }
        .btn-copy { background: #2980b9; color: white; }
        .btn-map { background: #27ae60; color: white; width: auto; padding: 10px 20px; }
        #mapContainer { position: relative; width: 750px; height: 750px; background: #050505; border: 2px solid #444; margin-top: 20px; border-radius: 8px; overflow: hidden; display: block; }
        canvas { width: 100%; height: 100%; cursor: crosshair; }
        #mapTooltip { position: fixed; background: rgba(0,0,0,0.95); color: #fff; padding: 10px; border: 1px solid #e74c3c; border-radius: 5px; pointer-events: none; display: none; font-size: 12px; z-index: 1000; }
        .map-coords { position: absolute; top: 10px; left: 10px; background: rgba(0,0,0,0.7); padding: 5px 10px; font-family: monospace; color: #00ff00; border-radius: 4px; border: 1px solid #333; pointer-events: none; }
        .stats-box { background: #111; border: 1px solid #333; padding: 15px; margin-top: 20px; border-radius: 8px; display: flex; justify-content: space-around; text-align: center; }
        .stat-item b { display: block; font-size: 18px; color: #2ecc71; }
        pre { background: #000; padding: 15px; color: #00ff00; border: 1px solid #333; height: 150px; overflow: auto; margin-top: 20px; font-size: 10px; border-radius: 5px; }
        .highlight-box { border: 1px solid #e67e22; padding: 10px; border-radius: 5px; background: rgba(230, 126, 34, 0.05); margin-bottom: 15px; }
    </style>
</head>
<body>

<div class="container">
    <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2>DayZ Territories Master ZPopulation <span style="font-size: 0.6em; color: #888;">
        <button class="btn btn-map" onclick="toggleMap()">üó∫Ô∏è Afficher / Masquer Carte</button>
    </div>
    
    <div class="layout">
        <div class="side">
            <label>1. Fichier XML Source</label>
            <textarea id="xmlInput" placeholder="Colle ton zombie_territories.xml ici..."></textarea>
            <button class="btn btn-parse" onclick="analyserFichier()">üîç Charger & Analyser</button>
            <div id="mapContainer">
                <canvas id="dayzMap"></canvas>
                <div id="mapTooltip"></div>
                <div class="map-coords" id="liveCoords">X: 0 | Z: 0</div>
            </div>
            <div class="stats-box">
                <div class="stat-item"><b id="totalStatic">0</b><label>Static Max</label></div>
                <div class="stat-item"><b id="totalDynamic" style="color:#3498db">0</b><label>Dyn. Max</label></div>
                <div class="stat-item"><b id="totalZones" style="color:#e67e22">0</b><label>Zones Totales</label></div>
            </div>
        </div>

        <div class="side config-panel">
            <label>2. Focus & S√©lection</label>
            <div class="grid" style="grid-template-columns: 1fr 1fr; margin-bottom: 20px;">
                <div class="field"><label>Groupe (Couleur)</label><select id="selectColor" onchange="onColorChange()"></select></div>
                <div class="field"><label>Type de Zombie</label><select id="selectZombieType" onchange="drawMap()"></select></div>
            </div>

            <div class="highlight-box">
                <label style="color:#2ecc71">‚öîÔ∏è Multiplication & Invasion</label>
                <div class="grid" style="grid-template-columns: 1fr 1fr;">
                    <div class="field"><label>Quantit√© Doublons</label>
                        <select id="duplicateFactor">
                            <option value="1">x1 (Original)</option>
                            <option value="2">x2</option>
                            <option value="3">x3</option>
                            <option value="4">x4</option>
                            <option value="5">x5</option>
                            <option value="10">x10</option>
                        </select>
                    </div>
                    <div class="field"><label>Forme de Dispersion</label>
                        <select id="dispersionShape">
                            <option value="circle">Cercle</option>
                            <option value="square">Carr√© / Grille</option>
                            <option value="random">Al√©atoire (Nuage)</option>
                        </select>
                    </div>
                </div>
                <div class="field" style="margin-top:10px;"><label>Distance Dispersion (m√®tres)</label><input type="number" id="offset" value="40"></div>
            </div>

            <label>‚öôÔ∏è Param√®tres des Zones</label>
            <div class="grid">
                <div class="field"><label>Static Min</label><input type="text" id="smin" value="0"></div>
                <div class="field"><label>Static Max</label><input type="text" id="smax" value="0"></div>
                <div class="field"><label>Rayon (r)</label><input type="text" id="radius" value="80"></div>
                <div class="field"><label>Dynamic Min</label><input type="text" id="dmin" value="5-8"></div>
                <div class="field"><label>Dynamic Max</label><input type="text" id="dmax" value="10-15"></div>
            </div>

            <button class="btn btn-apply" onclick="appliquerFusion()">üöÄ Appliquer l'Invasion (Safe)</button>
            <button class="btn btn-copy" onclick="copierXML()">üìã Copier le XML Final</button>
            <pre id="output"></pre>
        </div>
    </div>
</div>

<script>
let territoryData = [];
const MAP_SIZE = 15360;
const BOUNDARY_SAFE = 10; // Marge de s√©curit√© pour ne pas coller au bord pile

function toggleMap() {
    const container = document.getElementById('mapContainer');
    container.style.display = container.style.display === 'none' ? 'block' : 'none';
    if(container.style.display === 'block') drawMap();
}

function parseRange(val) {
    if (typeof val !== "string" || !val.includes("-")) return parseInt(val) || 0;
    const parts = val.split("-").map(p => parseInt(p.trim()));
    return Math.floor(Math.random() * (parts[1] - parts[0] + 1)) + parts[0];
}

function analyserFichier() {
    const xml = document.getElementById('xmlInput').value;
    const territoryRegex = /<territory color="(.*?)">([\s\S]*?)<\/territory>/g;
    territoryData = [];
    let match, options = '<option value="">-- VUE GLOBALE --</option>';
    let sTot=0, dTot=0, zCount=0;

    while ((match = territoryRegex.exec(xml)) !== null) {
        const color = match[1];
        const zones = [];
        const zRegex = /<zone name="(.*?)" smin="(\d+)" smax="(\d+)" dmin="(\d+)" dmax="(\d+)" x="([\d.-]+)" z="([\d.-]+)" r="([\d.-]+)"\s*\/>/g;
        let zm;
        while ((zm = zRegex.exec(match[2])) !== null) {
            sTot += parseInt(zm[3]); dTot += parseInt(zm[5]); zCount++;
            zones.push({ name: zm[1], smin: zm[2], smax: zm[3], dmin: zm[4], dmax: zm[5], x: zm[6], z: zm[7], r: zm[8] });
        }
        territoryData.push({ color, zones });
        options += `<option value="${color}">Groupe ${color} (${zones.length} zones)</option>`;
    }
    document.getElementById('selectColor').innerHTML = options;
    document.getElementById('totalStatic').textContent = sTot;
    document.getElementById('totalDynamic').textContent = dTot;
    document.getElementById('totalZones').textContent = zCount;
    drawMap();
}

function onColorChange() {
    updateSubFilters();
    drawMap();
}

function updateSubFilters() {
    const group = territoryData.find(g => g.color === document.getElementById('selectColor').value);
    if (!group) {
        document.getElementById('selectZombieType').innerHTML = '<option value="ALL">-- TOUS --</option>';
        return;
    }
    const names = [...new Set(group.zones.map(z => z.name))];
    let opt = '<option value="ALL">-- TOUS DANS CE GROUPE --</option>';
    names.forEach(n => opt += `<option value="${n}">${n}</option>`);
    document.getElementById('selectZombieType').innerHTML = opt;
}

function drawMap() {
    const canvas = document.getElementById('dayzMap');
    if(!canvas) return;
    const ctx = canvas.getContext('2d');
    const size = canvas.parentElement.clientWidth;
    canvas.width = size; canvas.height = size;
    const selColor = document.getElementById('selectColor').value;
    const selType = document.getElementById('selectZombieType').value;

    ctx.fillStyle = "#050505"; ctx.fillRect(0, 0, size, size);
    ctx.strokeStyle = "#1a1a1a";
    for(let i=0; i<size; i += size/15) { ctx.strokeRect(i, 0, 1, size); ctx.strokeRect(0, i, size, 1); }

    territoryData.forEach(g => {
        if (selColor && g.color !== selColor) return;
        g.zones.forEach(z => {
            if (selType && selType !== "ALL" && z.name !== selType) return;
            const px = (parseFloat(z.x) / MAP_SIZE) * size;
            const py = size - ((parseFloat(z.z) / MAP_SIZE) * size);
            ctx.fillStyle = z.name.includes("Army") ? "#e74c3c" : (z.name.includes("City") ? "#3498db" : "#f1c40f");
            ctx.beginPath(); ctx.arc(px, py, (selColor?3.5:2), 0, Math.PI*2); ctx.fill();
        });
    });
}

function appliquerFusion() {
    const selColor = document.getElementById('selectColor').value;
    const selType = document.getElementById('selectZombieType').value;
    if (!selColor) return alert("S√©lectionne un groupe !");

    const factor = parseInt(document.getElementById('duplicateFactor').value);
    const shape = document.getElementById('dispersionShape').value;
    const offsetVal = parseFloat(document.getElementById('offset').value);
    
    let finalXml = '<?xml version="1.0" encoding="UTF-8" standalone="yes" ?>\n<territory-type>\n';

    territoryData.forEach(group => {
        finalXml += `    <territory color="${group.color}">\n`;
        group.zones.forEach(zone => {
            const isT = (group.color === selColor && (selType === "ALL" || zone.name === selType));
            let loop = isT ? factor : 1;
            
            for(let i=0; i < loop; i++) {
                let x = parseFloat(zone.x);
                let z = parseFloat(zone.z);
                let r = isT ? parseRange(document.getElementById('radius').value) : zone.r;
                let smin = isT ? parseRange(document.getElementById('smin').value) : zone.smin;
                let smax = isT ? parseRange(document.getElementById('smax').value) : zone.smax;
                let dmin = isT ? parseRange(document.getElementById('dmin').value) : zone.dmin;
                let dmax = isT ? parseRange(document.getElementById('dmax').value) : zone.dmax;

                if (i > 0 && isT) {
                    if (shape === 'circle') {
                        let angle = (i * (2 * Math.PI)) / (loop - 1); 
                        x += Math.cos(angle) * offsetVal;
                        z += Math.sin(angle) * offsetVal;
                    } 
                    else if (shape === 'square') {
                        if(i===1) x+=offsetVal; if(i===2) x-=offsetVal; if(i===3) z+=offsetVal; if(i===4) z-=offsetVal;
                        if(i>4) { x += (Math.random()-0.5)*offsetVal*2; z += (Math.random()-0.5)*offsetVal*2; }
                    }
                    else {
                        x += (Math.random() - 0.5) * offsetVal * 2;
                        z += (Math.random() - 0.5) * offsetVal * 2;
                    }

                    // --- S√âCURIT√â ANTI-SORTIE DE MAP ---
                    if (x < BOUNDARY_SAFE) x = BOUNDARY_SAFE;
                    if (x > MAP_SIZE - BOUNDARY_SAFE) x = MAP_SIZE - BOUNDARY_SAFE;
                    if (z < BOUNDARY_SAFE) z = BOUNDARY_SAFE;
                    if (z > MAP_SIZE - BOUNDARY_SAFE) z = MAP_SIZE - BOUNDARY_SAFE;
                }
                finalXml += `        <zone name="${zone.name}" smin="${smin}" smax="${smax}" dmin="${dmin}" dmax="${dmax}" x="${x.toFixed(2)}" z="${z.toFixed(2)}" r="${r}"/>\n`;
            }
        });
        finalXml += `    </territory>\n`;
    });
    finalXml += '</territory-type>';
    document.getElementById('output').textContent = finalXml;
    alert("Invasion appliqu√©e avec s√©curit√© des bords de map !");
}

function copierXML() {
    navigator.clipboard.writeText(document.getElementById('output').textContent);
    alert("XML Copi√© !");
}

document.getElementById('dayzMap').addEventListener('mousemove', function(e) {
    const rect = e.target.getBoundingClientRect();
    const x = e.clientX - rect.left; const y = e.clientY - rect.top;
    const dX = Math.round((x / e.target.width) * MAP_SIZE);
    const dZ = Math.round(((e.target.width - y) / e.target.width) * MAP_SIZE);
    document.getElementById('liveCoords').textContent = `X: ${dX} | Z: ${dZ}`;
});
</script>
</body>
</html>